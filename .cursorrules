# TradeEdge Project Rules

## Architecture Principles

1. **Modular Python "Brains"**: Each analytics module is an independent script that:
   - Takes input, returns output (no shared state)
   - Outputs JSON to stdout for easy testing and integration
   - Can be run standalone via CLI
   - Has no dependencies on other scripts running first

2. **JSON-First Output**: All Python modules must output structured JSON:
   - Use `json.dumps()` for CLI output
   - Include `last_updated` timestamp in ISO format
   - Include error handling with clear error messages
   - Validate JSON structure before returning

3. **Data Caching**: All external API calls must be cached:
   - Cache location: `data/cache/{source}/{series}_{date}.json`
   - Cache TTL:
     - Alpha Vantage: Smart daily caching (only fetches if data through yesterday missing)
     - Yahoo Finance: 24-hour TTL
     - FRED: 7-day TTL
   - Always check cache before making API calls
   - Include cache hit/miss logging
   - Use `MarketDataManager` for unified market data access with intelligent routing

4. **Error Handling**: 
   - Never fail silently - log warnings/errors
   - Return partial results if some data is unavailable
   - Include `error` field in JSON output if issues occur
   - Use try/except blocks around all external API calls

## Coding Standards

### Python
- Use type hints for all function parameters and returns
- Include docstrings for all classes and functions
- Follow PEP 8 style guide
- Use `pathlib.Path` for file operations
- Use `datetime` objects, convert to ISO strings for JSON

### Testing
- Each module must be testable via CLI: `python module.py`
- CLI mode should output JSON to stdout
- Include unit tests in `backend/tests/`
- Test with known inputs and verify JSON structure

### Data Sources
- **Alpha Vantage** (Primary): Use `alpha_vantage` library, smart daily caching, 25 calls/day limit
  - Track budget via `api_budget_tracker.py`
  - Symbol mapping: ^GSPC → SPY, ^VIX → Yahoo Finance
  - Endpoint: TIME_SERIES_DAILY (free tier)
- **FRED API**: Use `fredapi` library, cache responses (7-day TTL)
- **Yahoo Finance** (Fallback): Use `yfinance` library, cache daily data (24-hour TTL)
  - Automatic fallback when Alpha Vantage fails or budget exhausted
- **Google Trends**: Use `pytrends` library, handle rate limits (planned for VP)

See `ALPHA_VANTAGE_INTEGRATION_2025-12-19.md` for market data routing strategy.

## CMDS Calculation Formula

```python
CMDS = (0.65 × FRS) + (0.35 × VP)
```

Where:
- FRS = Fundamental Risk Score (0-100)
- VP = Volatility Predictor score (0-100)
- CMDS = Combined Market Danger Score (0-100)

Allocation zones:
- 0-25: SAFE (90-100% equity)
- 26-45: CAUTIOUS (70-90% equity)
- 46-65: ELEVATED (50-70% equity)
- 66-80: HIGH (30-50% equity)
- 81-100: EXTREME (10-30% equity)

## FRS Component Scoring

### Category 1: Macro/Cycle (0-30 points)
- Unemployment trend: 0-10 points (delta from 12-month low)
- Yield curve: 0-10 points (inversion depth/duration)
- GDP vs stall speed: 0-10 points (<1.5% = 10 pts)

### Category 2: Valuation (0-25 points)
- Forward P/E: 0-10 points (22x+ = 10 pts)
- Buffett Indicator: 0-10 points (>140% = 10 pts)
- Equity yield vs T-bills: 0-10 points (equity yield < T-bills = 10 pts)
- Scaled to max 25 points

### Category 3: Leverage & Stability (0-25 points)
- Hedge fund leverage: 0-10 points (manual input)
- Corporate credit: 0-10 points (HY spreads)
- CRE stress: 0-10 points (delinquency rates)
- Scaled to max 25 points

### Category 4: Earnings (0-10 points)
- Earnings breadth: Compare S&P 500 vs equal-weight
- Margin vulnerability: Track profit margins

### Category 5: Sentiment (-10 to +10 points)
- Can reduce total risk if extreme fear + cash on sidelines
- Consumer confidence, VIX, money market assets

## File Organization

- Python modules: `backend/analytics/{category}/{module}.py`
- Data fetchers: `backend/analytics/data_fetchers/{source}_client.py`
- API endpoints: `backend/api/main.py`
- Tests: `backend/tests/test_{module}.py`
- Cache: `data/cache/{source}/{file}.json`
- Config: `data/config/{file}.json`

## API Design

- FastAPI endpoints: `/api/{module_name}`
- All endpoints return JSON
- Include CORS headers for frontend
- Cache responses for 5-15 minutes
- Health check endpoint: `/api/health`

## Frontend Integration

- Next.js app router with TypeScript
- Use SWR for data fetching with auto-refresh
- Components in `frontend/components/`
- Pages in `frontend/app/`
- Use shadcn/ui for UI components
- Use Recharts for data visualization

## Development Workflow

1. Build Python module standalone first
2. Test via CLI with JSON output
3. Add to FastAPI wrapper
4. Test API endpoint
5. Integrate into frontend
6. Write tests

## Documentation Maintenance

**CRITICAL**: When making major changes, update documentation to keep it synchronized with the codebase.

### Update Documentation When You:
- Add/remove/modify data sources (e.g., Alpha Vantage integration)
- Change architecture patterns (e.g., new caching strategy, routing logic)
- Add/modify core features (e.g., new FRS categories, API endpoints)
- Change environment requirements (e.g., new API keys, dependencies)
- Fix significant bugs that reveal important gotchas
- Add new modules or major components
- Modify file organization or structure

### Documentation Files to Update:

**Always Update**:
- `CLAUDE.md` - AI agent guidance (Tech Stack, API Endpoints, Gotchas, Workflows)
- `README.md` - User-facing quick start (if setup/testing changed)
- `backend/README.md` - Backend-specific docs (if API/testing changed)

**Create New Documentation**:
- Major integrations: `INTEGRATION_NAME_YYYY-MM-DD.md` (what, why, how, troubleshooting)
- Complex bug fixes: `BUG_FIX_DESCRIPTION_YYYY-MM-DD.md` (issue, cause, solution)

**Conditionally Update**:
- `.cursorrules` (this file) - If coding standards changed
- `PRD.md` - Only if product vision changed (rare)
- Architecture docs - Only if system design changed

### Documentation Process:
1. During development: Note what changed and why
2. Before committing: Review documentation checklist
3. Update relevant files with specific details (file paths, examples)
4. Add cross-references in CLAUDE.md's "Documentation References"
5. Test that commands/examples in docs still work

### Documentation Quality:
- Be concise: What changed and how to use it
- Be specific: Include file paths, function names, code examples
- Be current: Include dates and versions
- Be practical: Focus on actionable developer information
- Cross-reference: Link related documentation
- Test your docs: Verify commands actually work

### Good Examples:
- Alpha Vantage integration: Created dated MD, updated CLAUDE.md, README.md, backend/README.md
- yfinance fixes: Created dated MD documenting issue/solution, updated CLAUDE.md gotchas
- New FRS category: Updated CLAUDE.md, backend/README.md, category reference guide

**Remember**: Documentation is code. Keep it synchronized with implementation.

## Important Notes

- Never modify the plan file itself
- Always validate JSON output structure
- Handle missing data gracefully
- Log important operations for debugging
- Use environment variables for API keys
- Never commit API keys or sensitive data
- **UPDATE DOCUMENTATION for major changes** (see Documentation Maintenance above)

